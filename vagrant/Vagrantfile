# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile для среды разработки проекта управления Git-репозиториями
# Только Ubuntu 22.04 с необходимым ПО из Необходимое_ПО.md

Vagrant.configure("2") do |config|
  # Настройка для Ubuntu 22.04
  config.vm.box = "ubuntu/jammy64"
  config.vm.box_version = "20231215.0.0"
  config.vm.hostname = "git-repo-manager-dev"
  
  # Настройки ресурсов
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 8192  # 8GB RAM
    vb.cpus = 4       # 4 CPU cores
    vb.gui = false    # Без GUI для экономии ресурсов
    
    # Настройки виртуальной машины
    vb.customize ["modifyvm", :id, "--vram", "128"]
    vb.customize ["modifyvm", :id, "--accelerate3d", "off"]
    vb.customize ["modifyvm", :id, "--clipboard", "bidirectional"]
    vb.customize ["modifyvm", :id, "--draganddrop", "bidirectional"]
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--ioapic", "on"]
  end
  
  # Настройки сети
  config.vm.network "private_network", ip: "192.168.56.10"
  
  # Настройки SSH
  config.ssh.insert_key = false
  config.ssh.keys_only = false
  
  # Настройки времени ожидания
  config.vm.boot_timeout = 600
  config.vm.graceful_halt_timeout = 30
  
  # Скрипт установки ПО для Ubuntu
  config.vm.provision "shell", inline: <<-SHELL
    # Обновление системы
    sudo apt-get update
    sudo apt-get upgrade -y
    
    # Установка базовых инструментов
    sudo apt-get install -y curl wget unzip software-properties-common apt-transport-https ca-certificates gnupg lsb-release
    
    # Установка .NET 8 SDK
    wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
    sudo dpkg -i packages-microsoft-prod.deb
    rm packages-microsoft-prod.deb
    sudo apt-get update
    sudo apt-get install -y dotnet-sdk-8.0
    
    # Установка Git
    sudo apt-get install -y git
    
    # Установка Visual Studio Code
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
    sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
    sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
    rm -f packages.microsoft.gpg
    sudo apt-get update
    sudo apt-get install -y code
    
    # Установка дополнительных инструментов разработки
    sudo apt-get install -y build-essential cmake pkg-config
    sudo apt-get install -y libssl-dev libffi-dev libsqlite3-dev
    sudo apt-get install -y python3 python3-pip python3-venv
    
    # Установка Node.js
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
    
    # Установка Postman
    sudo snap install postman --classic
    
    # Установка инструментов для сборки
    sudo apt-get install -y appimagetool
    
    # Установка дополнительных Git инструментов
    sudo apt-get install -y git-flow
    
    # Установка инструментов мониторинга
    sudo apt-get install -y htop iotop
    
    # Установка Avalonia Templates
    dotnet new install Avalonia.Templates
    
    # Создание рабочей директории
    mkdir -p /home/vagrant/dev
    cd /home/vagrant/dev
    
    # Настройка Git
    git config --global user.name "Developer"
    git config --global user.email "developer@example.com"
    git config --global core.autocrlf input
    
    # Установка дополнительных расширений VS Code
    code --install-extension ms-dotnettools.csharp
    code --install-extension AvaloniaTeam.vscode-avalonia
    code --install-extension ms-vscode.vscode-json
    code --install-extension eamodio.gitlens
    code --install-extension ms-vscode.vscode-nuget-package-manager
    
    # Настройка прав доступа
    sudo chown -R vagrant:vagrant /home/vagrant/dev
    
    # Создание алиасов для удобства
    echo 'alias dev="cd /home/vagrant/dev"' >> /home/vagrant/.bashrc
    echo 'alias dotnet-run="dotnet run"' >> /home/vagrant/.bashrc
    echo 'alias dotnet-build="dotnet build"' >> /home/vagrant/.bashrc
    echo 'alias dotnet-test="dotnet test"' >> /home/vagrant/.bashrc
    
    echo "=== Установка ПО для Ubuntu завершена! ==="
  SHELL
  
  # Post-install скрипт для проверки установки
  config.vm.provision "shell", inline: <<-SHELL, run: "always"
    echo "=== Проверка установленного ПО ==="
    echo "ОС: $(uname -a)"
    echo "Git: $(git --version)"
    echo ".NET: $(dotnet --version)"
    echo "Node.js: $(node --version)"
    echo "Python: $(python3 --version)"
    echo "VS Code: $(code --version)"
    echo "=== Проверка завершена ==="
    echo ""
    echo "=== Инструкции по использованию ==="
    echo "1. Подключитесь: vagrant ssh"
    echo "2. Перейдите в рабочую папку: cd /home/vagrant/dev"
    echo "3. Создайте проект: dotnet new avalonia.mvvm -n GitRepositoryManager"
    echo "4. Запустите VS Code: code ."
    echo "=== Готово к разработке! ==="
  SHELL
end 